name: CI/CD Discord Bot Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_HOST: ${{ secrets.EC2_HOST }}
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      HEADER: ${{ secrets.HEADER }}
      DB_TYPE: ${{ secrets.DB_TYPE }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PORT: ${{ secrets.DB_PORT }}
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      REDIS_USE_TLS: ${{ secrets.REDIS_USE_TLS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Debug EC2_HOST value
        run: echo "EC2_HOST is '$EC2_HOST'"

      - name: Deploy to EC2 and setup .env
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem $EC2_USER@$EC2_HOST /bin/bash << 'ENDSSH'
          mkdir -p ~/anialert
          cd ~/anialert
          cat > .env << EOF
DISCORD_BOT_TOKEN="${DISCORD_BOT_TOKEN}"
CLIENT_ID="${CLIENT_ID}"
HEADER="${HEADER}"
DB_TYPE="${DB_TYPE}"
DB_HOST="${DB_HOST}"
DB_NAME="${DB_NAME}"
DB_USER="${DB_USER}"
DB_PASSWORD="${DB_PASSWORD}"
DB_PORT="${DB_PORT}"
REDIS_HOST="${REDIS_HOST}"
REDIS_PORT="${REDIS_PORT}"
REDIS_USE_TLS="${REDIS_USE_TLS}"
EOF
          docker stop anialert-bot || true
          docker rm anialert-bot || true
          docker build -t anialert-bot .
          docker run -d --name anialert-bot --env-file .env anialert-bot
          docker ps
          ENDSSH
